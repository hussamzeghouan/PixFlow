<script>
function updatePercentLabel(value) {
  document.getElementById('percentLabel').innerText = value + '%';
}
function updateCornerLabel(value) {
  document.getElementById('cornerLabel').innerText = value + '%';
}
function toggleSettings(panelId) {
  const panel = document.getElementById(panelId);
  if (!panel) return;
  const isVisible = panel.style.display === 'block';
  panel.style.display = isVisible ? 'none' : 'block';
  const checkboxId = panelId.replace('Settings', '');
  const label = document.getElementById(checkboxId + 'Label');
  if (label) {
    if (isVisible) label.classList.remove('active');
    else label.classList.add('active');
  }
}
function getRandomColor(dark = false) {
  if (dark) {
    return '#' + Math.floor(Math.random() * 0x444444).toString(16).padStart(6, '0');
  }
  return '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0');
}
function applyColorPreset() {
  const preset = document.getElementById('colorPreset').value;
  const palette = document.getElementById('colorPalette');
  palette.innerHTML = '';
  let colors = [];
  switch(preset) {
    case 'retro': colors = ['#FF6B6B', '#4ECDC4', '#F9D423', '#FF4E50', '#556270']; break;
    case 'ocean': colors = ['#1A535C', '#4ECDC4', '#F7FFF7', '#2B7A78', '#DEF2F1']; break;
    case 'sunset': colors = ['#F9C80E', '#FF4365', '#5B2E5F', '#F15946', '#2C0835']; break;
    case 'forest': colors = ['#2D3047', '#93B7BE', '#E0CA3C', '#A37B45', '#3A5311']; break;
    default: colors = ['#ff6666', '#66aaff', '#66ff66', '#ffff66', '#ff66ff'];
  }
  colors.forEach(color => {
    const div = document.createElement('div');
    div.className = 'color';
    div.style.backgroundColor = color;
    div.setAttribute('data-color', color);
    div.addEventListener('click', function() {
      document.querySelectorAll('.color').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('fillColor').value = this.getAttribute('data-color');
    });
    palette.appendChild(div);
  });
  if (palette.firstChild) {
    palette.firstChild.classList.add('active');
    document.getElementById('fillColor').value = colors[0];
  }
}
function generateGrid() {
  const svg = document.getElementById('grid');
  svg.innerHTML = '';
  const cellWidth = parseInt(document.getElementById('cellWidth').value) || 40;
  const cellHeight = parseInt(document.getElementById('cellHeight').value) || 40;
  const columns = parseInt(document.getElementById('columns').value) || 10;
  const rows = parseInt(document.getElementById('rows').value) || 10;
  const fillColor = document.getElementById('fillColor').value;
  const secondaryColor = document.getElementById('secondaryColor').value;
  const bgColor = document.getElementById('bgColor').value;
  const fillPercent = parseInt(document.getElementById('fillPercent').value) || 50;
  const randomSize = document.getElementById('randomSize').checked;
  const roundedCorners = document.getElementById('roundedCorners').checked;
  const multiColor = document.getElementById('multiColor').checked;
  const applyShear = document.getElementById('applyShear').checked;
  const gradientFill = document.getElementById('gradientFill').checked;
  const cornerRadius = parseInt(document.getElementById('cornerRadius').value) || 10;
  const gradientStart = document.getElementById('gradientStart')?.value || '#ff6666';
  const gradientEnd = document.getElementById('gradientEnd')?.value || '#66aaff';
  const gradientDirection = document.getElementById('gradientDirection')?.value || 'horizontal';
  svg.setAttribute('width', columns * cellWidth);
  svg.setAttribute('height', rows * cellHeight);
  svg.style.background = bgColor;
  if (gradientFill) {
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    svg.appendChild(defs);
    const gradient = document.createElementNS('http://www.w3.org/2000/svg',
      gradientDirection === 'radial' ? 'radialGradient' : 'linearGradient');
    gradient.setAttribute('id', 'cellGradient');
    if (gradientDirection !== 'radial') {
      switch(gradientDirection) {
        case 'horizontal': gradient.setAttribute('x1', '0%'); gradient.setAttribute('y1', '50%'); gradient.setAttribute('x2', '100%'); gradient.setAttribute('y2', '50%'); break;
        case 'vertical': gradient.setAttribute('x1', '50%'); gradient.setAttribute('y1', '0%'); gradient.setAttribute('x2', '50%'); gradient.setAttribute('y2', '100%'); break;
        case 'diagonal': gradient.setAttribute('x1', '0%'); gradient.setAttribute('y1', '0%'); gradient.setAttribute('x2', '100%'); gradient.setAttribute('y2', '100%'); break;
      }
    }
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', gradientStart);
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop2.setAttribute('offset', '100%');
    stop2.setAttribute('stop-color', gradientEnd);
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    defs.appendChild(gradient);
  }
  let colors = [];
  if (multiColor) {
    document.querySelectorAll('.color').forEach(color => {
      colors.push(color.getAttribute('data-color'));
    });
  }
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < columns; x++) {
      if (Math.random() * 100 > fillPercent) continue;
      let width = cellWidth;
      let height = cellHeight;
      if (randomSize) {
        width *= 0.5 + Math.random();
        height *= 0.5 + Math.random();
      }
      let color = fillColor;
      if (multiColor && colors.length > 0) {
        color = colors[Math.floor(Math.random() * colors.length)];
      }
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x * cellWidth);
      rect.setAttribute('y', y * cellHeight);
      rect.setAttribute('width', width);
      rect.setAttribute('height', height);
      rect.setAttribute('fill', gradientFill ? 'url(#cellGradient)' : color);
      if (roundedCorners) {
        const rx = (cornerRadius / 100) * (cellWidth / 2);
        const ry = (cornerRadius / 100) * (cellHeight / 2);
        rect.setAttribute('rx', rx);
        rect.setAttribute('ry', ry);
      }
      if (applyShear) {
        const skewX = Math.random() * 20 - 10;
        const skewY = Math.random() * 20 - 10;
        rect.setAttribute('transform', `skewX(${skewX}) skewY(${skewY})`);
      }
      svg.appendChild(rect);
    }
  }
}
function exportSVG() {
  const svg = document.getElementById('grid');
  const serializer = new XMLSerializer();
  const source = serializer.serializeToString(svg);
  const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'pixflow-pattern.svg';
  link.click();
  setTimeout(() => URL.revokeObjectURL(url), 100);
}
function exportPNG() {
  const svg = document.getElementById('grid');
  const serializer = new XMLSerializer();
  const source = serializer.serializeToString(svg);
  const img = new Image();
  const svgBlob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);
  img.onload = function() {
    const canvas = document.createElement('canvas');
    canvas.width = parseInt(svg.getAttribute('width'));
    canvas.height = parseInt(svg.getAttribute('height'));
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = document.getElementById('bgColor').value;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
    URL.revokeObjectURL(url);
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = 'pixflow-pattern.png';
    link.click();
  };
  img.src = url;
}
function randomizeAll() {
  document.getElementById('cellWidth').value = Math.floor(Math.random() * 45) + 15;
  document.getElementById('cellHeight').value = Math.floor(Math.random() * 45) + 15;
  document.getElementById('columns').value = Math.floor(Math.random() * 15) + 5;
  document.getElementById('rows').value = Math.floor(Math.random() * 15) + 5;
  const fillPercent = Math.floor(Math.random() * 80) + 20;
  document.getElementById('fillPercent').value = fillPercent;
  updatePercentLabel(fillPercent);
  document.getElementById('fillColor').value = getRandomColor();
  document.getElementById('secondaryColor').value = getRandomColor();
  document.getElementById('bgColor').value = getRandomColor(true);
  document.getElementById('randomSize').checked = Math.random() > 0.5;
  document.getElementById('roundedCorners').checked = Math.random() > 0.5;
  document.getElementById('multiColor').checked = Math.random() > 0.5;
  document.getElementById('applyShear').checked = Math.random() > 0.5;
  document.getElementById('gradientFill').checked = Math.random() > 0.5;
  if (document.getElementById('roundedCorners').checked) {
    document.getElementById('roundedCornersSettings').style.display = 'block';
  } else {
    document.getElementById('roundedCornersSettings').style.display = 'none';
  }
  if (document.getElementById('multiColor').checked) {
    document.getElementById('multiColorSettings').style.display = 'block';
  } else {
    document.getElementById('multiColorSettings').style.display = 'none';
  }
  if (document.getElementById('gradientFill').checked) {
    document.getElementById('gradientSettings').style.display = 'block';
  } else {
    document.getElementById('gradientSettings').style.display = 'none';
  }
  generateGrid();
}
window.onload = function() {
  updatePercentLabel(document.getElementById('fillPercent').value);
  updateCornerLabel(document.getElementById('cornerRadius').value);
  document.querySelectorAll('.checkboxes input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const label = this.parentElement;
      if (this.checked) label.classList.add('active');
      else label.classList.remove('active');
      if (this.id === 'roundedCorners') document.getElementById('roundedCornersSettings').style.display = this.checked ? 'block' : 'none';
      if (this.id === 'multiColor') document.getElementById('multiColorSettings').style.display = this.checked ? 'block' : 'none';
      if (this.id === 'gradientFill') document.getElementById('gradientSettings').style.display = this.checked ? 'block' : 'none';
    });
  });
  document.querySelectorAll('.color').forEach(color => {
    color.addEventListener('click', function() {
      document.querySelectorAll('.color').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('fillColor').value = this.getAttribute('data-color');
    });
  });
  generateGrid();
}
</script>
